# General builder for (EUPS-labeled) dev containers. This is a composite action
# rather than a reusable workflow to give the caller more flexibility in
# defining the inputs (e.g., using env).

name: "Update dev image"
inputs:
  imageName:
    description: The container image to update.
    required: true
    type: string
  baseImage:
    description: The fully qualified name of the PP base container to build from.
    required: true
    type: string
  baseTag:
    description: The tag of the PP base container to build from.
    required: true
    type: string
  ghcr_user:
    description: The user name for logging in to GHCR.
    required: true
    type: string
  ghcr_token:
    description: The token for logging in to GHCR.
    required: true
    type: string

permissions:
  packages: write

runs:
  using: composite
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ inputs.ghcr_user }}
        password: ${{ inputs.ghcr_token }}
    - name: Determine eups tag
      env:
        BASE_IMAGE: ${{ inputs.baseImage }}
        BASE_TAG: ${{ inputs.baseTag }}
      shell: bash
      run: |
        docker run "$BASE_IMAGE":"$BASE_TAG" bash -c "cat conda/envs/lsst-scipipe-*/share/eups/ups_db/global.tags" > eups.tag || docker run "$BASE_IMAGE":"$BASE_TAG" bash -c "cat stack/miniconda*/ups_db/global.tags" > eups.tag || echo "Unknown" > eups.tag
        echo "Eups tag = $(< eups.tag)"
    - name: Build image
      env:
        IMAGE_NAME: ${{ inputs.imageName }}
        BASE_IMAGE: ${{ inputs.baseImage }}
        BASE_TAG: ${{ inputs.baseTag }}
      shell: bash
      run: |
        docker build . -f Dockerfile \
          --build-arg "BASE_TAG=$BASE_TAG" \
          --tag $IMAGE_NAME \
          --label "runnumber=${GITHUB_RUN_ID}" \
          --label "basetag=${BASE_TAG}" \
          --label "eupstag=$(< eups.tag)"
    - name: Push image to container registries
      env:
        IMAGE_NAME: ${{ inputs.imageName }}
        BASE_IMAGE: ${{ inputs.baseImage }}
        BASE_TAG: ${{ inputs.baseTag }}
      shell: bash
      run: |
        BRANCH=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
        [ "$BRANCH" == "merge" ] && BRANCH=$(echo "${{ github.head_ref }}" | sed -e 's,.*/\(.*\),\1,')

        for IMAGE_ID in "ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME"; do
          if [ "$BRANCH" == "main" ]; then
            VERSION="$BASE_TAG"
          else
            VERSION="${BRANCH}-$BASE_TAG"
          fi
          echo IMAGE_ID=$IMAGE_ID
          echo VERSION=$VERSION
          docker tag $IMAGE_NAME $IMAGE_ID:$VERSION
          docker push $IMAGE_ID:$VERSION
          EUPS_TAG=$(< eups.tag)
          if [ "$EUPS_TAG" != "Unknown" ] && [ "$BASE_TAG" != "$EUPS_TAG" ]; then
            if [ "$BRANCH" == "main" ]; then
              VERSION="$EUPS_TAG"
            else
              VERSION="${BRANCH}-$EUPS_TAG"
            fi
            echo VERSION=$VERSION
            docker tag $IMAGE_NAME $IMAGE_ID:$VERSION
            docker push $IMAGE_ID:$VERSION
          fi
        done
